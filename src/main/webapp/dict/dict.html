<html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<head>
<link rel="stylesheet" href="../js/jquery-ui.css">
    <link rel="stylesheet" href="../js/bootstraptable/css/bootstrap.min.css"> 
    <link rel="stylesheet" href="../js/bootstraptable/css/bootstrap-table.min.css">
<script type="text/javascript" src="../js/jquery-2.2.2.js"></script>
<script type="text/javascript" src="../js/jquery-ui.js"></script>
<script type="text/javascript" src="../js/jquery-rest.js"></script>
<script src="../js/bootstraptable/js/bootstrap.min.js"></script>
<script src="../js/bootstraptable/js/tableExport.js"></script>
<script src="../js/bootstraptable/js/bootstrap-table.js"></script>
<script src="../js/bootstraptable/js/bootstrap-table-export.js"></script>
<script src="../js/knockout-3.4.2.js"></script>
<script src="../js/knockout.mapping-latest.js"></script>
<script src="../js/bootstraptable/js/knockout.bootstraptable.js"></script>
<script>

//初始化
$(function () {
    //1、初始化表格
    tableInit.Init();

    //2、注册增删改事件
    operate.operateInit();
});

//初始化表格
var tableInit = {
    Init: function () {
        //绑定table的viewmodel
        this.myViewModel = new ko.bootstrapTableViewModel({
            url: '../rest/dict/all',         //请求后台的URL（*）
            method: 'get',                      //请求方式（*）
            toolbar: '#toolbar',                //工具按钮用哪个容器
            queryParams: function (param) {
                return { limit: param.limit, offset: param.offset,search:param.search };
            },//传递参数（*）
            pagination: true,                   //是否显示分页（*）
            detailView:true,
            sidePagination: "server",           //分页方式：client客户端分页，server服务端分页（*）
            pageNumber: 1,                      //初始化加载第一页，默认第一页
            pageSize: 2,                       //每页的记录行数（*）
            pageList: [2, 4, 6, 8],        //可供选择的每页的行数（*）
           
          //注册加载子表的事件。注意下这里的三个参数！
            onExpandRow: function (index, row, $detail) {
            	alert("abc");
                //oInit.InitSubTable(index, row, $detail);
            }
        });
        ko.applyBindings(this.myViewModel, document.getElementById("tb_dict"));
    }
};


//操作
var operate = {
    //初始化按钮事件
    operateInit: function () {
        this.operateAdd();
        this.operateUpdate();
        this.operateDelete();
        this.dictModel = {
            dictId: ko.observable(),
            dictName: ko.observable()
        };
    },
    //新增
    operateAdd: function(){
        $('#btn_add').on("click", function () {
            $("#myModal").modal().on("shown.bs.modal", function () {
            	$("#myModalLabel").text("新增");
                var oEmptyModel = {
                    dictId: ko.observable(),
                    dictName: ko.observable()
                };
                ko.utils.extend(operate.dictModel, oEmptyModel);
                ko.applyBindings(operate.dictModel, document.getElementById("myModal"));
                operate.operateSave();
            }).on('hidden.bs.modal', function () {
                ko.cleanNode(document.getElementById("myModal"));
            });
        });
    },
    //编辑
    operateUpdate: function () {
        $('#btn_edit').on("click", function () {
        	
        	var arrselectedData = tableInit.myViewModel.getSelections();
            if (!operate.operateCheck(arrselectedData)) { 
            	return; 
            }
            $("#myModalLabel").text("修改");
            $("#myModal").modal().on("shown.bs.modal", function () {
                //将选中该行数据有数据Model通过Mapping组件转换为viewmodel
                ko.utils.extend(operate.dictModel, ko.mapping.fromJS(arrselectedData[0]));
                ko.applyBindings(operate.dictModel, document.getElementById("myModal"));
                operate.operateSave();
            }).on('hidden.bs.modal', function () {
                //关闭弹出框的时候清除绑定(这个清空包括清空绑定和清空注册事件)
                ko.cleanNode(document.getElementById("myModal"));
            });
        });
    },
    //删除
    operateDelete: function () {
        $('#btn_delete').on("click", function () {
            var arrselectedData = tableInit.myViewModel.getSelections();
            $.ajax({
                url: "../rest/dict/delete",
                type: "post",
                contentType: 'application/json',
                data: JSON.stringify(arrselectedData),
                success: function (data, status) {
                    tableInit.myViewModel.refresh();
                }
            });
        });
    },
    //保存数据
    operateSave: function () {
        $('#btn_submit').on("click", function () {
        	console.log("submit click");
            //取到当前的viewmodel
            var oViewModel = operate.dictModel;
            console.log("oViewModel", oViewModel);
            //将Viewmodel转换为数据model
            var oDataModel = ko.toJS(oViewModel);
            console.log("oDataModel", oDataModel);
            var funcName = oDataModel.dictId?"modify":"add";
            console.log("funcName", funcName);
            $.restPost({
                url: "../rest/dict/"+funcName,
                data: oDataModel,
                success: function (data, status) {
                    tableInit.myViewModel.refresh();
                }
            });
        });
    },
    //数据校验
    operateCheck:function(arr){
        if (arr.length <= 0) {
            alert("请至少选择一行数据");
            return false;
        }
        if (arr.length > 1) {
            alert("只能编辑一行数据");
            return false;
        }
        return true;
    }
}
</script>
</head>
<body>
	<div class="panel-body" style="padding-bottom:0px;">
		<div id="toolbar" class="btn-group">
            <button id="btn_add" type="button" class="btn btn-default">
                <span class="glyphicon glyphicon-plus" aria-hidden="true"></span>新增
            </button>
            <button id="btn_edit" type="button" class="btn btn-default">
                <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>修改
            </button>
            <button id="btn_delete" type="button" class="btn btn-default">
                <span class="glyphicon glyphicon-remove" aria-hidden="true"></span>删除
            </button>
        </div>
       <table id="tb_dict" data-bind="myBootstrapTable:$root">
            <thead>
                <tr>
                    <th data-checkbox="true"></th>
                    <th data-field="dictId">字典id</th>
                    <th data-field="dictName">字典名称</th>
                </tr>
            </thead>
        </table>
        
	</div>
	<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="myModalLabel">操作</h4>
                    </div>
                    <div class="modal-body">

                        <div class="form-group">
                            <label for="txt_dictName">字典名称</label>
                            <input type="text" name="txt_dictName" data-bind="value:dictName" class="form-control" id="txt_dictName" placeholder="字典名称">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span>关闭</button>
                        <button type="button" id="btn_submit" class="btn btn-primary" data-dismiss="modal"><span class="glyphicon glyphicon-floppy-disk" aria-hidden="true"></span>保存</button>
                    </div>
                </div>
            </div>
        </div>
</body>
</html>
